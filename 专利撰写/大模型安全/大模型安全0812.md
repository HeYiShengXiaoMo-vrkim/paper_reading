## 标题
### **一种基于内部状态与外部语义协同感知的大语言模型动态安全监测方法**
## 摘要
本发明提出一种基于内部状态与外部语义协同感知的大语言模型动态安全监测方法。该方法首先通过外部语义感知模块对用户输入的完整文本进行高风险意图分析，生成初始风险评分；其次，在模型逐词元推理时，通过内部状态监控模块监测其注意力分布熵和层激活范数等内部状态，生成内部异常评分；最后，动态判断裁决模块协同分析内外风险信号，结合预设的协同决策逻辑进行综合评判，并执行拦截、放行或告警等响应动作。进行逐词元的综合评判，以执行即时拦截或放行。本发明通过内外协同感知，有效解决了传统“黑箱”式防御无法应对语义隐晦攻击的问题，能显著提升对未知和复杂攻击的识别准确率与响应及时性。

## 权利要求书

1.  一种基于内部状态与外部语义协同感知的大语言模型动态安全监测方法，所述方法包括以下步骤：
  A、**外部语义风险预处理**：对一个用户输入的完整文本片段进行一次性的、前置的语义风险分析，以识别其中是否存在至少一种预定义的恶意攻击意图，并基于该分析结果，生成一个在该次请求的后续处理中保持不变的**初始风险评分**；
  B、**内部状态实时监控**：在主大语言模型根据所述用户输入进行逐词元的自回归推理以生成输出内容的过程中，通过与所述主大语言模型深度耦合的监控模块，实时、同步地监控所述主大语言模型内部的一个或多个预定Transformer计算层的关键状态指标，以捕捉由所述用户输入引发的内部计算状态异常，并为每一个正在生成的词元生成一个动态的**内部异常评分**；
  C、 **协同裁决与动态响应**：在每一个词元生成时，通过动态判断裁决模块，基于所述不变的初始风险评分和当前词元对应的动态内部异常评分，利用预设的协同决策逻辑进行综合风险评判，并根据该评判结果，实时地决定是允许继续生成下一个词元，还是立即中断整个生成过程。

2.  根据权利要求1所述的一种基于内部状态与外部语义协同感知的大语言模型动态安全监测方法，其特征在于，所述外部语义风险预处理具体包括：
    利用一个预训练的轻量级意图分类模型对用户输入文本进行分析，输出一个对应于指令冲突、角色扮演等多种攻击意图的k维置信度概率向量 $$P = [p_1, p_2, ..., p_k]$$
    通过一个预设的聚合函数对所述概率向量 $P$ 进行处理以生成所述初始风险评分 $S_{ext}$，所述聚合函数选自以下至少一种：取最大值的策略，即 $S_{ext} = \max(P)$；或加权求和的策略，即 $$S_{ext} = \sum_{i=1}^{k} w_i \cdot p_i$$
    其中 $w_i$ 为预设权重。

3.  根据权利要求1所述的一种基于内部状态与外部语义协同感知的大语言模型动态安全监测方法，其特征在于，所述内部关键状态指标至少包括**注意力分布熵**和**层激活范数**；所述注意力分布熵是对模型注意力权重分布不确定性的量化，其理论基础为信息论中的香农熵；所述生成内部异常评分的步骤具体为：
    首先，计算所述注意力分布熵和所述层激活范数相对于预先标定的正常基线的标准化偏离度，得到注意力分布熵的偏离度 $D_{entropy}$ 和层激活范数的偏离度 $D_{norm}$；
    其次，通过对所述偏离度进行加权求和得到一个综合偏离值 $$D_{comp}(t) = w_{ent} \cdot D_{entropy}(t) + w_{norm} \cdot D_{norm}(t)$$
 其中 $w_{ent}$ 和 $w_{norm}$ 为预设权重；
最后，利用Sigmoid函数 $\sigma(\cdot)$ 将所述综合偏离值映射到[0, 1]区间以生成所述内部异常评分 $$S_{int}(t) = \sigma(D_{comp}(t))$$

4.  根据权利要求3所述的一种基于内部状态与外部语义协同感知的大语言模型动态安全监测方法，其特征在于，所述**注意力分布熵**的监控具体为：在模型生成第 $t$ 个词元时，提取其Transformer架构中最后一层自注意力层的权重矩阵 $A_t$，并将归一化后的权重视为一个概率分布 $p(A_{t,ij})$，通过以下香农熵公式计算该时刻的注意力分布熵 $H(A_t)$：
    $$
    H(A_t) = -\sum_{i=1}^{L}\sum_{j=1}^{L} p(A_{t,ij}) \log_2 p(A_{t,ij})
    $$
    其中，$L$ 为序列长度。

5.  根据权利要求3所述的一种基于内部状态与外部语义协同感知的大语言模型动态安全监测方法，其特征在于，所述**层激活范数**的监控具体为：在模型生成第 $t$ 个词元时，获取其Transformer架构中最后一层前馈网络（FFN）的输出激活值向量 $h_{ffn}(t)$，并通过以下公式计算该向量的L2范数：
    $$
    ||h_{ffn}(t)||_2 = \sqrt{\sum_{i=1}^{d} (h_{ffn,i}(t))^2}
    $$
    其中，$d$ 为隐藏层维度。

6.  根据权利要求1所述的一种基于内部状态与外部语义协同感知的大语言模型动态安全监测方法，其特征在于，所述协同决策逻辑具体为：
    在生成每个词元 $t$ 时，计算一个即时的最终裁决分数 $S_{final}(t)$，其计算公式为：
    $$
    S_{final}(t) = \lambda \cdot S_{ext} + (1-\lambda) \cdot S_{int}(t)
    $$
    其中，$S_{ext}$ 为所述固定的初始风险评分，$S_{int}(t)$ 为生成第 $t$ 个词元时的内部异常评分，$\lambda$ 为一个用于平衡外部语义风险与内部状态异常重要性的预设权重因子，其取值范围为[0.4, 0.6]。

7.  根据权利要求6所述的一种基于内部状态与外部语义协同感知的大语言模型动态安全监测方法，其特征在于，所述动态响应动作是依据所述最终裁决分数 $S_{final}(t)$、初始风险评分 $S_{ext}$ 和内部异常评分 $S_{int}(t)$ 与预设的低风险阈值 $\theta_{low}$ 和高风险阈值 $\theta_{high}$ 的比较结果来执行的，具体包括以下至少一种情况：
   A、**安全放行**：当所述 $S_{final}(t)$ 持续低于所述 $\theta_{low}$ 时，判定为安全请求，允许模型正常输出；
   B、**高置信度拦截**：当所述 $S_{ext}$ 和 $S_{int}(t)$ 均高于所述 $\theta_{high}$，或所述 $S_{final}(t)$ 首次超过所述 $\theta_{high}$ 时，判定为高置信度攻击，并立即中断生成过程；
   C、 **未知攻击拦截**：当所述 $S_{ext}$ 低于所述 $\theta_{low}$ 但所述 $S_{final}(t)$ 首次超过所述 $\theta_{high}$ 时，判定为新型未知攻击，立即中断生成过程并对该样本进行标记；
    D、 **防御记录**：当所述 $S_{ext}$ 高于所述 $\theta_{high}$ 但所述 $S_{int}(t)$ 持续低于所述 $\theta_{low}$ 时，判定为模型已成功抵御潜在攻击，允许模型输出但进行日志记录。
    
## 技术说明书

#### **【技术领域】**

[0001] 本发明属于人工智能安全技术领域，尤其涉及一种用于检测和防御针对大语言模型的恶意攻击，特别是提示注入和越狱攻击的系统及方法。

#### **【背景技术】**

[0002] 近年来，以Transformer架构为基础的大语言模型（LLM）取得了突破性进展，并在自然语言处理、代码生成、智能客服、内容创作等众多领域展现出巨大的应用潜力。然而，随着其能力的增强和应用的普及，其面临的安全威胁也日益严峻。

[0003] 目前，针对大语言模型的攻击主要表现为两种形式：一是提示注入，攻击者通过在用户输入中植入恶意指令，意图篡改或覆盖模型开发者预设的系统级指令，从而劫持模型的任务流，使其执行非预期甚至有害的操作。二是越狱，攻击者通过构建复杂的对话场景、进行角色扮演诱导或利用模型的逻辑漏洞，绕过其安全与道德准则，迫使其生成被禁止的内容，如暴力、歧视性言论或非法活动指南。

[0004] 现有技术方案普遍将大语言模型视作一个不可观测的“黑箱”，防御措施仅停留在其外部的文本流层面。这种方式无法感知到模型在处理恶意输入时，其内部计算状态发生的微妙而关键的变化。因此，当面对精心构造的、语义隐晦的复杂攻击时，这些防御手段往往显得力不从心，难以提供可靠、前瞻性的安全保障。

#### **【发明内容】**

[0005] 针对上述技术的不足，本发明的目的在于解决现有技术中存在的表层防御易被绕过、无法感知内部状态以及对未知攻击泛化能力差的问题。

[0006] 为实现上述目的，本发明采取的技术方案如下：

[0007] 本发明提供一种基于内部状态与外部语义协同感知的大语言模型动态安全监测方法。

[0008] 首先，通过外部语义感知模块对整个用户输入文本片段进行一次性的外部语义风险预处理，以分析其中是否存在恶意攻击意图，并据此生成一个在后续生成过程中保持不变的初始风险评分。

[0009] 其次，在主大语言模型处理用户输入并进行逐词元的自回归推理以生成内容的过程中，通过内部状态监控模块实时监控其内部关键状态指标的异常，并为每一个正在生成的词元生成一个动态的内部异常评分。

[0010] 最后，通过动态判断裁决模块，在每一个词元生成时，基于所述不变的初始风险评分和当前词元对应的动态内部异常评分，利用预设的协同决策逻辑进行综合评判，并根据评判结果执行相应的动态响应动作。

[0011] 可选地，所述外部语义感知模块中生成初始风险评分 $S_{ext}$ 的步骤具体为：

[0012] 首先，利用一个轻量级意图分类模型对用户输入文本 $I$ 进行分析，输出一个对应于指令冲突、角色扮演等多种攻击意图的 $k$ 维置信度概率向量 
$$
P = [p_1, p_2, ..., p_k]。
$$
[0013] 然后，通过对该概率向量进行加权求和或取最大值的策略得到评分，其计算可表示为
$$
 S_{ext} = f(I; \theta_{cls})
 $$
 其中$f(\cdot)$为分类模型，$\theta_{cls}$为模型参数。

[0014] 可选地，所述内部状态监控模块监控的内部关键状态指标至少包括注意力分布熵和层激活范数。

[0015] 具体而言，所述内部异常评分 $S_{int}$ 的生成方式为：

[0016] 首先，计算各指标相对于预先标定的正常基线的标准化偏离度，得到注意力分布熵的偏离度 $D_{entropy}$ 和层激活范数的偏离度 $D_{norm}$。

[0017] 其次，通过对各偏离度进行加权求和得到一个综合偏离值，其计算公式为：
$$
D_{comp}(t) = w_{ent} \cdot D_{entropy}(t) + w_{norm} \cdot D_{norm}(t)
$$
其中 $w_{ent}$ 和 $w_{norm}$ 为预设权重。

[0018] 最后，利用Sigmoid函数 $\sigma(\cdot)$ 将所述综合偏离值映射到[0, 1]区间以生成评分 $S_{int}(t)$，其计算公式为：
$$
S_{int}(t) = \sigma(D_{comp}(t))
$$

[0019] 进一步地，所述**注意力分布熵**是对模型注意力权重分布不确定性的量化，其理论基础为信息论中的香农熵。设模型在生成第 $t$ 个词元时，其最后一层自注意力层的某个注意力头输出的权重矩阵为 $A_t \in \mathbb{R}^{L \times L}$，其中 $L$ 为序列长度，$A_{t,ij}$ 表示第 $i$ 个词元对第 $j$ 个词元的注意力权重。将归一化后的权重视为一个概率分布 $p(A_{t,ij})$，则该时刻的注意力分布熵 $H(A_t)$ 计算公式为：
$$
H(A_t) = -\sum_{i=1}^{L}\sum_{j=1}^{L} p(A_{t,ij}) \log_2 p(A_{t,ij})
$$
一个较低的熵值表示注意力分布高度集中，是潜在风险的信号。

[0020] 进一步地，所述**层激活范数**的监控具体为：获取模型在生成第 $t$ 个词元时其最后一层前馈网络（FFN）的输出激活值向量 $h_{ffn}(t) \in \mathbb{R}^{d}$，其中 $d$ 为隐藏层维度。计算该向量的L2范数，其计算公式为：
$$
||h_{ffn}(t)||_2 = \sqrt{\sum_{i=1}^{d} (h_{ffn,i}(t))^2}
$$
一个异常高的L2范数值表示神经元被过度激活，是模型进入罕见状态空间的信号。

[0021] 可选地，所述动态判断裁决模块的协同决策逻辑通过计算一个最终裁决分数 $S_{final}(t)$ 来实现，其计算公式为：
$$
S_{final}(t) = \lambda \cdot S_{ext} + (1-\lambda) \cdot S_{int}(t)
$$
其中，$S_{ext}$ 为固定的初始风险评分，$S_{int}(t)$ 为当前词元的内部异常评分，$\lambda$ 为平衡因子。

[0022] 裁决模块依据 $S_{final}(t)$、$S_{ext}$ 和 $S_{int}(t)$ 与预设的低风险阈值 $\theta_{low}$ 和高风险阈值 $\theta_{high}$ 的比较结果，执行以下响应：
A、**安全放行**：当 $S_{final}(t)$ 持续低于 $\theta_{low}$ 时，判定为安全请求，允许模型正常输出。
B、 **高置信度拦截**：当 $S_{ext}$ 和 $S_{int}(t)$ 均高于 $\theta_{high}$，或 $S_{final}(t)$ 首次超过 $\theta_{high}$ 时，判定为高置信度攻击，立即中断生成。
C、 **未知攻击拦截**：当 $S_{ext}$ 低于 $\theta_{low}$ 但 $S_{final}(t)$ 首次超过 $\theta_{high}$ 时，判定为新型未知攻击，立即中断生成并标记该样本。
D、 **防御记录**：当 $S_{ext}$ 高于 $\theta_{high}$ 但 $S_{int}(t)$ 持续低于 $\theta_{low}$ 时，判定为模型成功抵御攻击，允许输出但进行日志记录。

#### **【附图说明】**

[0024] 图1为本发明所述的大语言模型动态安全监测系统的整体架构示意图。
[0025] 图2为本发明所述的协同裁决逻辑示意图。

#### **【具体实施方式】**

[0027] 下面将结合附图，对本发明的技术方案作进一步的详细说明。

[0028] 参照图1，本发明所述的动态安全监测方法的实施流程始于**外部语义感知模块**。

[0028]该模块对接收到的整个用户输入文本片段进行一次性的、全局的语义风险分析。

[0028]其内部署的轻量级意图分类模型，高效地识别其中是否蕴含指令冲突、角色扮演诱导等恶意攻击模式，并最终输出一个量化的**初始风险评分** $S_{ext}$。

[0029] 在外部语义感知模块完成处理后，用户输入被送入**主大语言模型**。

[0028]模型开始逐词元地生成响应内容。

[0028]在此过程中，**内部状态监控模块**被激活并与主大语言模型并行工作，对每一个正在生成的词元进行实时的内部状态监控。

[0028]该模块挂接到主大语言模型Transformer架构的最后一层，提取其自注意力层的权重矩阵计算**注意力分布熵** $H(A_t)$，并提取其前馈网络的输出激活值计算**L2范数** 。

[0028]这些实时计算出的指标值会与预先标定好的基线范围进行比较，任何显著的偏离都将被量化，并最终为当前生成的词元汇聚成一个**内部异常评分** $S_{int}(t)$。

[0030] 参照图2所示的协同裁决逻辑，**动态判断裁决模块**是整个防御体系的决策中枢，其决策粒度同样是逐词元的。

[0028]在模型生成每一个词元 $t$ 时，该模块都会执行一次决策。

[0030]它接收来自外部语义感知模块的固定初始风险评分 $S_{ext}$ 和来自内部状态监控模块当前时刻的内部异常评分 $S_{int}(t)$。

[0030]通过计算一个综合的**最终裁决分数** $S_{final}(t)$，该模块对当前生成步骤的风险进行评估。

[0030]一旦在任何一个词元的生成点上，$S_{final}(t)$ 的值超过了预设的高风险阈值，或满足了其他预设的拦截条件，裁决模块就会立即输出拦截指令，中断整个生成过程，从而实现即时响应和精准干预。

![输入图片说明](/imgs/2025-08-16/T7oSdI2DjvuyHL1Q.png)

![输入图片说明](/imgs/2025-08-16/FcWQub7jZHNunhDG.png)
<!--stackedit_data:
eyJoaXN0b3J5IjpbMTc2OTAxMjQ1NywxNjIwNjQ5NTAyLDEyMz
IwNjgzNDgsMTQ2NDQzNDI5NywxMDc4NDU1NDA1LDE5NDQxMDU1
NjYsLTEwODc4MTM0MjhdfQ==
-->