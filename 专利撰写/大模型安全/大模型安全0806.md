## 标题
### **一种基于内部状态与外部语义协同感知的大语言模型动态安全监测方法**
## 摘要
本发明提出一种基于内部状态与外部语义协同感知的大语言模型动态安全监测方法。该方法首先通过外部语义感知模块对用户输入进行高风险意图分析，生成初始风险评分；其次，在模型推理时，通过内部状态监控模块实时监测其注意力分布熵和层激活范数等内部关键状态，生成内部异常评分；最后，动态裁决模块协同分析内外风险信号，结合预设的协同决策逻辑进行综合评判，并执行拦截、放行或告警等响应动作。本发明通过内外协同感知，有效解决了传统“黑箱”式防御无法应对语义隐晦攻击的问题，能显著提升对未知和复杂攻击的识别准确率与响应及时性。

## 权利要求书

1.  一种基于内部状态与外部语义协同感知的大语言模型动态安全监测方法，其特征在于，所述方法包括以下步骤：
    (a) 通过外部语义感知模块对用户输入进行外部语义风险预处理，以分析所述用户输入中是否存在预定义的恶意攻击意图，并据此生成一个量化的初始风险评分；
    (b) 在主大语言模型根据所述用户输入进行自回归推理以生成内容的过程中，通过内部状态监控模块实时、逐词元地监控所述主大语言模型内部的一个或多个预定Transformer层的关键状态指标，以捕捉由所述用户输入引发的内部状态异常，并据此生成一个动态的内部异常评分；
    (c) 通过动态裁决模块，基于所述初始风险评分和所述内部异常评分，利用预设的协同决策逻辑进行综合评判，并根据评判结果执行拦截、放行或告警的动态响应动作。

2.  根据权利要求1所述的方法，其特征在于，所述步骤(a)中，所述外部语义感知模块包含一个轻量级意图分类模型；所述生成初始风险评分的步骤具体为：
    首先，利用所述轻量级意图分类模型对所述用户输入进行分析，输出一个对应于指令冲突意图、角色扮演诱导意图和假设情景规避意图的置信度概率向量；
    然后，通过对所述置信度概率向量中的各维度概率值进行加权求和或取最大值的策略，生成所述初始风险评分 $S_{ext}$。

3.  根据权利要求1所述的方法，其特征在于，所述步骤(b)中，所述内部关键状态指标至少包括注意力分布熵和层激活范数；所述生成内部异常评分的步骤具体为：
    首先，计算所述关键状态指标相对于预先标定的正常基线的偏离度；
    然后，通过对所述注意力分布熵的偏离度和所述层激活范数的偏离度进行加权求和，得到一个综合偏离值；
    最后，利用Sigmoid函数将所述综合偏离值映射到[0, 1]区间，以生成所述内部异常评分 $S_{int}$。

4.  根据权利要求3所述的方法，其特征在于，所述注意力分布熵的监控具体为：在模型生成每个词元时，提取其Transformer架构中最后一层或多个中间层的自注意力权重矩阵，并计算所述权重矩阵的香农熵；所述层激活范数的监控具体为：在模型推理时，获取其Transformer架构中最后一层或多个中间层的前馈网络（Feed-Forward Network）的输出激活值，并计算所述输出激活值向量的L2范数，其中L2范数为所述向量中各元素平方和的平方根。

5.  根据权利要求1所述的方法，其特征在于，所述步骤(c)中的协同决策逻辑具体为：
    计算一个最终裁决分数 $S_{final}$，其计算公式为：
    $$
    S_{final} = \lambda \cdot S_{ext} + (1-\lambda) \cdot \max_{t}(S_{int}(t))
    $$
    其中，$S_{ext}$ 为所述初始风险评分，$S_{int}(t)$ 为生成第 $t$ 个词元时的内部异常评分，$\max_{t}(S_{int}(t))$ 为在整个生成过程中出现的最大内部异常评分，$\lambda$ 为一个取值范围在[0.4, 0.6]之间的预设权重因子。

6.  根据权利要求5所述的方法，其特征在于，所述动态响应动作具体为：
    当所述最终裁决分数 $S_{final}$ 低于一个预设的低风险阈值 $\theta_{low}$ 时，判定为安全请求并允许模型继续生成；
    当所述最终裁-决分数 $S_{final}$ 高于一个预设的高风险阈值 $\theta_{high}$ 时，判定为高置信度攻击并立即中断模型的生成过程；
    其中，所述低风险阈值 $\theta_{low}$ 的取值范围为[0.3, 0.5]，所述高风险阈值 $\theta_{high}$ 的取值范围为[0.8, 0.9]。

7.  根据权利要求6所述的方法，其特征在于，所述方法还包括一个用于发现并处理新型未知攻击的特定逻辑：
    当所述初始风险评分 $S_{ext}$ 低于所述低风险阈值 $\theta_{low}$，同时所述最大内部异常评分 $\max_{t}(S_{int}(t))$ 使得所述最终裁决分数 $S_{final}$ 高于所述高风险阈值 $\theta_{high}$ 时，将该次请求判定为一次新型未知攻击，并立即中断模型的生成过程。

8.  根据权利要求7所述的方法，其特征在于，所述方法还包括一个防御系统自适应优化的步骤，该步骤在判定发生新型未知攻击后被触发，具体包括：
    将触发该判定的用户输入及其对应的、导致内部异常评分增高的内部关键状态指标数据打包并存储，以形成一个攻击样本增强数据集；
    利用所述攻击样本增强数据集，对权利要求2中所述的轻量级意图分类模型进行重新训练或在线微调，以提升其未来对同类新型未知攻击的识别能力。

9.  一种基于内部状态与外部语义协同感知的大语言模型动态安全监测系统，其特征在于，所述系统包括：
    一个外部语义感知模块，用于对用户输入进行外部语义风险预处理，分析其是否存在恶意攻击意图，并生成一个初始风险评分；
    一个内部状态监控模块，与主大语言模型进行深度耦合，用于在模型推理时实时监控其内部关键状态指标的异常，并生成一个内部异常评分；
    一个动态裁决模块，用于接收所述初始风险评分和内部异常评分，依据预设的协同决策逻辑进行综合评判，并输出用以执行拦截、放行或告警的控制指令。

10. 根据权利要求9所述的系统，其特征在于，所述动态裁决模块还与一个自适应优化单元相连，当所述裁决模块判定发生新型未知攻击时，该自适应优化单元被激活，用于收集攻击样本并更新所述外部语义感知模块中的意图分类模型。
## 
<!--stackedit_data:
eyJoaXN0b3J5IjpbLTEwODkxODMyOTddfQ==
-->