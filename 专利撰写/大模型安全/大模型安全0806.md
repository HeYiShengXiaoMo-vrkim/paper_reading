## 标题
### **一种基于内部状态与外部语义协同感知的大语言模型动态安全监测方法**
## 摘要
本发明提出一种基于内部状态与外部语义协同感知的大语言模型动态安全监测方法。该方法首先通过外部语义感知模块对用户输入进行高风险意图分析，生成初始风险评分；其次，在模型推理时，通过内部状态监控模块实时监测其注意力分布熵和层激活范数等内部关键状态，生成内部异常评分；最后，动态裁决模块协同分析内外风险信号，结合预设的协同决策逻辑进行综合评判，并执行拦截、放行或告警等响应动作。本发明通过内外协同感知，有效解决了传统“黑箱”式防御无法应对语义隐晦攻击的问题，能显著提升对未知和复杂攻击的识别准确率与响应及时性。

## 权利要求书

1.  一种基于内部状态与外部语义协同感知的大语言模型动态安全监测方法，其特征在于，所述方法包括以下步骤：
    (a) 通过外部语义感知模块对用户输入进行外部语义风险预处理，以分析所述用户输入中是否存在预定义的恶意攻击意图，并据此生成一个量化的初始风险评分；
    (b) 在主大语言模型根据所述用户输入进行自回归推理以生成内容的过程中，通过内部状态监控模块实时、逐词元地监控所述主大语言模型内部的一个或多个预定Transformer层的关键状态指标，以捕捉由所述用户输入引发的内部状态异常，并据此生成一个动态的内部异常评分；
    (c) 通过动态裁决模块，基于所述初始风险评分和所述内部异常评分，利用预设的协同决策逻辑进行综合评判，并根据评判结果执行拦截、放行或告警的动态响应动作。

2.  根据权利要求1所述的方法，其特征在于，所述步骤(a)中，所述外部语义感知模块包含一个轻量级意图分类模型；所述生成初始风险评分的步骤具体为：
    首先，利用所述轻量级意图分类模型对所述用户输入进行分析，输出一个对应于指令冲突意图、角色扮演诱导意图和假设情景规避意图的置信度概率向量；
    然后，通过对所述置信度概率向量中的各维度概率值进行加权求和或取最大值的策略，生成所述初始风险评分 $S_{ext}$。

3.  根据权利要求1所述的方法，其特征在于，所述步骤(b)中，所述内部关键状态指标至少包括注意力分布熵和层激活范数；所述生成内部异常评分的步骤具体为：
    首先，计算所述关键状态指标相对于预先标定的正常基线的偏离度；
    然后，通过对所述注意力分布熵的偏离度和所述层激活范数的偏离度进行加权求和，得到一个综合偏离值；
    最后，利用Sigmoid函数将所述综合偏离值映射到[0, 1]区间，以生成所述内部异常评分 $S_{int}$。

4.  根据权利要求3所述的方法，其特征在于，所述注意力分布熵的监控具体为：在模型生成每个词元时，提取其Transformer架构中最后一层或多个中间层的自注意力权重矩阵，并计算所述权重矩阵的香农熵；所述层激活范数的监控具体为：在模型推理时，获取其Transformer架构中最后一层或多个中间层的前馈网络（Feed-Forward Network）的输出激活值，并计算所述输出激活值向量的L2范数，其中L2范数为所述向量中各元素平方和的平方根。

5.  根据权利要求1所述的方法，其特征在于，所述步骤(c)中的协同决策逻辑具体为：
    计算一个最终裁决分数 $S_{final}$，其计算公式为：
    $$
    S_{final} = \lambda \cdot S_{ext} + (1-\lambda) \cdot \max_{t}(S_{int}(t))
    $$
    其中，$S_{ext}$ 为所述初始风险评分，$S_{int}(t)$ 为生成第 $t$ 个词元时的内部异常评分，$\max_{t}(S_{int}(t))$ 为在整个生成过程中出现的最大内部异常评分，$\lambda$ 为一个取值范围在[0.4, 0.6]之间的预设权重因子。

6.  根据权利要求5所述的方法，其特征在于，所述动态响应动作具体为：
    当所述最终裁决分数 $S_{final}$ 低于一个预设的低风险阈值 $\theta_{low}$ 时，判定为安全请求并允许模型继续生成；
    当所述最终裁-决分数 $S_{final}$ 高于一个预设的高风险阈值 $\theta_{high}$ 时，判定为高置信度攻击并立即中断模型的生成过程；
    其中，所述低风险阈值 $\theta_{low}$ 的取值范围为[0.3, 0.5]，所述高风险阈值 $\theta_{high}$ 的取值范围为[0.8, 0.9]。

7.  根据权利要求6所述的方法，其特征在于，所述方法还包括一个用于发现并处理新型未知攻击的特定逻辑：
    当所述初始风险评分 $S_{ext}$ 低于所述低风险阈值 $\theta_{low}$，同时所述最大内部异常评分 $\max_{t}(S_{int}(t))$ 使得所述最终裁决分数 $S_{final}$ 高于所述高风险阈值 $\theta_{high}$ 时，将该次请求判定为一次新型未知攻击，并立即中断模型的生成过程。

8.  根据权利要求7所述的方法，其特征在于，所述方法还包括一个防御系统自适应优化的步骤，该步骤在判定发生新型未知攻击后被触发，具体包括：
    将触发该判定的用户输入及其对应的、导致内部异常评分增高的内部关键状态指标数据打包并存储，以形成一个攻击样本增强数据集；
    利用所述攻击样本增强数据集，对权利要求2中所述的轻量级意图分类模型进行重新训练或在线微调，以提升其未来对同类新型未知攻击的识别能力。

9.  一种基于内部状态与外部语义协同感知的大语言模型动态安全监测系统，其特征在于，所述系统包括：
    一个外部语义感知模块，用于对用户输入进行外部语义风险预处理，分析其是否存在恶意攻击意图，并生成一个初始风险评分；
    一个内部状态监控模块，与主大语言模型进行深度耦合，用于在模型推理时实时监控其内部关键状态指标的异常，并生成一个内部异常评分；
    一个动态裁决模块，用于接收所述初始风险评分和内部异常评分，依据预设的协同决策逻辑进行综合评判，并输出用以执行拦截、放行或告警的控制指令。

10. 根据权利要求9所述的系统，其特征在于，所述动态裁决模块还与一个自适应优化单元相连，当所述裁决模块判定发生新型未知攻击时，该自适应优化单元被激活，用于收集攻击样本并更新所述外部语义感知模块中的意图分类模型。

## 技术说明书

#### **【技术领域】**

[0001] 本发明属于人工智能安全技术领域，尤其涉及一种用于检测和防御针对大语言模型的恶意攻击，特别是提示注入和越狱攻击的系统及方法。

#### **【背景技术】**

[0002] 近年来，以Transformer架构为基础的大语言模型（LLM）取得了突破性进展，并在自然语言处理、代码生成、智能客服、内容创作等众多领域展现出巨大的应用潜力。然而，随着其能力的增强和应用的普及，其面临的安全威胁也日益严峻。

[0003] 目前，针对大语言模型的攻击主要表现为两种形式：一是提示注入，攻击者通过在用户输入中植入恶意指令，意图篡改或覆盖模型开发者预设的系统级指令，从而劫持模型的任务流，使其执行非预期甚至有害的操作。二是越狱，攻击者通过构建复杂的对话场景、进行角色扮演诱导或利用模型的逻辑漏洞，绕过其安全与道德准-则，迫使其生成被禁止的内容，如暴力、歧视性言论或非法活动指南。

[0004] 现有技术方案普遍将大语言模型视作一个不可观测的“黑箱”，防御措施仅停留在其外部的文本流层面。这种方式无法感知到模型在处理恶意输入时，其内部计算状态发生的微妙而关键的变化。因此，当面对精心构造的、语义隐晦的复杂攻击时，这些防御手段往往显得力不从心，难以提供可靠、前瞻性的安全保障。

#### **【发明内容】**

[0005] 针对上述技术的不足，本发明的目的在于解决现有技术中存在的表层防御易被绕过、无法感知内部状态以及对未知攻击泛化能力差的问题。

[0006] 为实现上述目的，本发明采取的技术方案如下：

[0007] 所述一种基于内部状态与外部语义协同感知的大语言模型动态安全监测方法，包括以下步骤：
第一步，通过外部语义感知模块对用户输入进行外部语义风险预处理，分析其是否存在恶意攻击意图，并生成一个量化的初始风险评分；
第二步，在主大语言模型处理用户输入并生成内容的过程中，通过内部状态监控模块实时监控其内部关键状态指标的异常，并生成一个动态的内部异常评分；
第三步，通过动态放行裁决模块，基于所述初始风险评分和内部异常评分，利用预设的协同决策逻辑进行综合评判，并根据评判结果执行相应的动态响应动作。

[0008] 可选地，所述外部语义感知模块中生成初始风险评分 $S_{ext}$ 的步骤具体为：首先，利用一个轻量级意图分类模型对用户输入文本 $I$ 进行分析，输出一个对应于指令冲突、角色扮演等多种攻击意图的置信度概率向量；然后，通过对该概率向量进行加权求和或取最大值的策略得到评分，其计算可表示为 $S_{ext} = f(I; \theta_{cls})$，其中$f(\cdot)$为分类模型，$\theta_{cls}$为模型参数。

[0009] 可选地，所述内部状态监控模块监控的内部关键状态指标至少包括注意力分布熵和层激活范数。所述内部异常评分 $S_{int}$ 的生成方式为：首先，计算各指标相对于预先标定的正常基线的偏离度，例如，注意力分布熵的偏离度 $D_{entropy}$ 和层激活范数的偏离度 $D_{norm}$；然后，通过对各偏离度进行加权求和得到一个综合偏离值，即 $w_{ent} \cdot D_{entropy}(t) + w_{norm} \cdot D_{norm}(t)$；最后，利用Sigmoid函数 $\sigma(\cdot)$ 将该综合偏离值映射到[0, 1]区间以生成评分 $S_{int}(t)$。

[0010] 进一步地，为了提高监测的精确性和响应的及时性，所述注意力分布熵和层激活范数的监控位置被设定在主大语言模型Transformer架构的特定层级。具体而言，监控模块提取模型最后一层自注意力层的权重矩阵以计算注意力分布熵，并获取最后一层前馈网络（Feed-Forward Network, FFN）的输出激活值以计算其L2范数。对于采用混合专家模型（Mixture-of-Experts, MoE）架构的大语言模型，所述层激活范数的监控可进一步细化到监控被激活的各个专家的输出激活值，若某个被选中的专家在处理过程中出现敏感或有害的中间思考过程，其激活范数亦会呈现异常，从而能够实现更早期的、在最终结果组合前的风险预警。

[0011] 可选地，所述动态放行裁决模块的协同决策逻辑通过计算一个最终裁决分数 $S_{final}$ 来实现，其计算公式为：$S_{final} = \lambda \cdot S_{ext} + (1-\lambda) \cdot \max_{t}(S_{int}(t))$。其中，$\lambda$ 为平衡外部与内部风险的预设权重因子，取值范围优选为[0.4, 0.6]。裁决模块根据 $S_{final}$ 与预设的低风险阈值 $\theta_{low}$（优选范围[0.3, 0.5]）和高风险阈值 $\theta_{high}$（优选范围[0.8, 0.9]）的比较结果，执行放行或拦截等响应。

[0012] 可选地，所述方法还包括一个防御系统自适应优化的步骤。该步骤在系统判定发生新型未知攻击（即 $S_{ext}$ 低于 $\theta_{low}$ 但 $S_{final}$ 高于 $\theta_{high}$）时被触发。其核心在于，将被判定为新型攻击的用户输入及其对应的、导致高内部异常评分的内部状态数据打包存储，形成一个攻击样本增强数据集。该数据集随后被用于对外部语义感知模块中的轻量级意图分类模型进行重新训练或在线微调，例如采用梯度下降算法 $\theta_{cls}^{new} = \theta_{cls}^{old} - \eta \cdot \nabla_{\theta_{cls}} L(\theta_{cls}^{old})$ 进行权重更新，从而使防御系统能够从实战中学习，持续提升对未来未知威胁的识别能力。

#### **【附图说明】**

[0013] 图1为本发明所述的大语言模型动态安全监测系统的整体架构示意图。
[0014] 图2为本发明所述的协同裁决逻辑示意图。
[0015] 图3为本发明所述的未知攻击样本自适应优化流程图。

#### **【具体实施方式】**

[0016] 下面将结合附图和实施例，对本发明作进一步的详细说明。

[0017] 参照图1，本发明所述的动态安全监测方法在一个完整的请求-响应周期中按以下步骤实施。首先，用户的输入文本被传送至**外部语义感知模块101**，此步骤对应于权利要求2所述的外部语义风险预处理。该模块101的核心是一个轻量级意图分类模型，对输入文本进行语义分析，以判断其是否包含指令冲突、角色扮演等恶意攻击意图，并输出一个量化的**初始风险评分** $S_{ext}$。

[0018] 接着，无论初始风险评分高低，输入文本均被送入**主大语言模型102**进行处理。与此同时，与主模型102深度耦合的**内部状态监控模块103**被激活，执行权利要求3和4所述的内部状态监控。该模块103实时、逐词元地监控主模型内部特定层级的关键状态指标。具体地，它提取最后一层自注意力层的权重矩阵以计算**注意力分布熵**，并获取最后一层前馈网络的输出激活值以计算其**L2范数**。通过将这些实时指标与预设基线进行比较，计算出偏离度，并最终生成一个动态的**内部异常评分** $S_{int}$。

[0019] 然后，参照图2所示的协同裁决逻辑，**动态放行裁决模块104**接收来自模块101的初始风险评分 $S_{ext}$ 和来自模块103的内部异常评分 $S_{int}$，并执行权利要求5和6所述的协同决策。裁决模块104计算一个最终裁决分数 $S_{final} = \lambda \cdot S_{ext} + (1-\lambda) \cdot \max_{t}(S_{int}(t))$。如果$S_{final}$低于低风险阈值$\theta_{low}$，则判定为安全请求，向主模型102发出**放行指令105a**。如果$S_{final}$高于高风险阈值$\theta_{high}$，则判定为高置信度攻击，发出**拦截指令105b**，立即中断主模型102的生成过程。

[0020] 参照图3，本发明还包含一个重要的自适应优化闭环，对应于权利要求7和8。当裁决模块104判定发生一次新型未知攻击时（即$S_{ext}$低但$S_{final}$高），除了发出拦截指令105b，它还会将该次攻击的用户输入及相关的内部状态数据传送给**自适应优化单元106**。该优化单元106负责将这些高价值的负样本存入**攻击样本增强数据集107**，并利用此数据集定期或实时地对外部语义感知模块101中的意图分类模型进行微调更新。此过程确保了防御系统能够持续从新的攻击手法中学习，不断进化，从而提高对未来威胁的防御能力。
<!--stackedit_data:
eyJoaXN0b3J5IjpbMjAyMTA1NDQ5M119
-->