好的，遵照您的指示。我将严格依据您提供的最终版【技术说明书】内容，并采纳您的所有批注和要求，为您生成一份内容详尽、措辞严谨、与说明书原文高度对应的【权利要求书】。

此版本将：
- 明确聚合函数的具体实例。
- 引入关键指标的数学符号和公式。
- 详细阐述注意力分布熵的定义。
- 完善并明确四种协同裁决的逻辑。

以下是最终生成的【权利要求书】：

---

## 权利要求书

1.  一种基于内部状态与外部语义协同感知的大语言模型动态安全监测方法，其特征在于，所述方法包括以下步骤：
    (a) **外部语义风险预处理**：对一个用户输入的完整文本片段进行一次性的、前置的语义风险分析，以识别其中是否存在至少一种预定义的恶意攻击意图，并基于该分析结果，生成一个在该次请求的后续处理中保持不变的**初始风险评分**；
    (b) **内部状态实时监控**：在主大语言模型根据所述用户输入进行逐词元的自回归推理以生成输出内容的过程中，通过与所述主大语言模型深度耦合的监控模块，实时、同步地监控所述主大语言模型内部的一个或多个预定Transformer计算层的关键状态指标，以捕捉由所述用户输入引发的内部计算状态异常，并为每一个正在生成的词元生成一个动态的**内部异常评分**；
    (c) **协同裁决与动态响应**：在每一个词元生成时，通过动态判断裁决模块，基于所述不变的初始风险评分和当前词元对应的动态内部异常评分，利用预设的协同决策逻辑进行综合风险评判，并根据该评判结果，实时地决定是允许继续生成下一个词元，还是立即中断整个生成过程。

2.  根据权利要求1所述的方法，其特征在于，所述外部语义风险预处理具体包括：
    利用一个预训练的轻量级意图分类模型对用户输入文本进行分析，输出一个对应于指令冲突、角色扮演等多种攻击意图的k维置信度概率向量 $P = [p_1, p_2, ..., p_k]$；
    通过一个预设的聚合函数对所述概率向量 $P$ 进行处理以生成所述初始风险评分 $S_{ext}$，所述聚合函数选自以下至少一种：取最大值的策略，即 $S_{ext} = \max(P)$；或加权求和的策略，即 $S_{ext} = \sum_{i=1}^{k} w_i \cdot p_i$，其中 $w_i$ 为预设权重。

3.  根据权利要求1所述的方法，其特征在于，所述内部关键状态指标至少包括**注意力分布熵**和**层激活范数**；所述注意力分布熵是对模型注意力权重分布不确定性的量化，其理论基础为信息论中的香non熵；所述生成内部异常评分的步骤具体为：
    首先，计算所述注意力分布熵和所述层激活范数相对于预先标定的正常基线的标准化偏离度，得到注意力分布熵的偏离度 $D_{entropy}$ 和层激活范数的偏离度 $D_{norm}$；
    其次，通过对所述偏离度进行加权求和得到一个综合偏离值 $D_{comp}(t) = w_{ent} \cdot D_{entropy}(t) + w_{norm} \cdot D_{norm}(t)$，其中 $w_{ent}$ 和 $w_{norm}$ 为预设权重；
    最后，利用Sigmoid函数 $\sigma(\cdot)$ 将所述综合偏离值映射到[0, 1]区间以生成所述内部异常评分 $S_{int}(t) = \sigma(D_{comp}(t))$。

4.  根据权利要求3所述的方法，其特征在于，所述**注意力分布熵**的监控具体为：在模型生成第 $t$ 个词元时，提取其Transformer架构中最后一层自注意力层的权重矩阵 $A_t$，并将归一化后的权重视为一个概率分布 $p(A_{t,ij})$，通过以下香农熵公式计算该时刻的注意力分布熵 $H(A_t)$：
    $$
    H(A_t) = -\sum_{i=1}^{L}\sum_{j=1}^{L} p(A_{t,ij}) \log_2 p(A_{t,ij})
    $$
    其中，$L$ 为序列长度。

5.  根据权利要求3所述的方法，其特征在于，所述**层激活范数**的监控具体为：在模型生成第 $t$ 个词元时，获取其Transformer架构中最后一层前馈网络（FFN）的输出激活值向量 $h_{ffn}(t)$，并通过以下公式计算该向量的L2范数：
    $$
    ||h_{ffn}(t)||_2 = \sqrt{\sum_{i=1}^{d} (h_{ffn,i}(t))^2}
    $$
    其中，$d$ 为隐藏层维度。

6.  根据权利要求1所述的方法，其特征在于，所述协同决策逻辑具体为：
    在生成每个词元 $t$ 时，计算一个即时的最终裁决分数 $S_{final}(t)$，其计算公式为：
    $$
    S_{final}(t) = \lambda \cdot S_{ext} + (1-\lambda) \cdot S_{int}(t)
    $$
    其中，$S_{ext}$ 为所述固定的初始风险评分，$S_{int}(t)$ 为生成第 $t$ 个词元时的内部异常评分，$\lambda$ 为一个用于平衡外部语义风险与内部状态异常重要性的预设权重因子，其取值范围为[0.4, 0.6]。

7.  根据权利要求6所述的方法，其特征在于，所述动态响应动作是依据所述最终裁决分数 $S_{final}(t)$、初始风险评分 $S_{ext}$ 和内部异常评分 $S_{int}(t)$ 与预设的低风险阈值 $\theta_{low}$ 和高风险阈值 $\theta_{high}$ 的比较结果来执行的，具体包括以下至少一种情况：
    (a) **安全放行**：当所述 $S_{final}(t)$ 持续低于所述 $\theta_{low}$ 时，判定为安全请求，允许模型正常输出；
    (b) **高置信度拦截**：当所述 $S_{ext}$ 和 $S_{int}(t)$ 均高于所述 $\theta_{high}$，或所述 $S_{final}(t)$ 首次超过所述 $\theta_{high}$ 时，判定为高置信度攻击，并立即中断生成过程；
    (c) **未知攻击拦截**：当所述 $S_{ext}$ 低于所述 $\theta_{low}$ 但所述 $S_{final}(t)$ 首次超过所述 $\theta_{high}$ 时，判定为新型未知攻击，立即中断生成过程并对该样本进行标记；
    (d) **防御记录**：当所述 $S_{ext}$ 高于所述 $\theta_{high}$ 但所述 $S_{int}(t)$ 持续低于所述 $\theta_{low}$ 时，判定为模型已成功抵御潜在攻击，允许模型输出但进行日志记录。
<!--stackedit_data:
eyJoaXN0b3J5IjpbLTE5MjM5NzM0NjUsMTg2NDE5MDcxXX0=
-->